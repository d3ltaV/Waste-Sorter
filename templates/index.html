{% extends "base.html" %}
<!-- Extends means we reuse base.html’s layout and just fill in blocks -->

{% block title %}Upload | Waste-Sorter{% endblock %}
<!-- Sets the <title> text for the browser tab -->

{% block content %}
<section class="hero">
  <!-- Big headline to orient the user -->
  <h1>Sort smarter.</h1>
  <!-- Short explanatory sentence sets expectations -->
  <p>Upload a photo of an item to see if it belongs in recycling, trash, or compost.</p>
</section>

<!-- Upload form:
     - method="POST": file uploads must use POST
     - action="{{ url_for('predict') }}": where to send the form
     - enctype="multipart/form-data": REQUIRED so the file actually uploads -->
<form id="uploadForm" class="card upload" method="POST" action="{{ url_for('predict') }}" enctype="multipart/form-data">
  <!-- Visual drop area for better UX. The actual <input type="file"> is visually hidden. -->
  <div id="dropzone" class="dropzone" tabindex="0" aria-label="Image dropzone">
    <!-- name="image": Flask will use this key in request.files['image'] -->
    <input id="fileInput" type="file" name="image" accept="image/*" class="sr-only">
    <!-- Copy prompts let the user know they can drag or click -->
    <div class="dz-content">
      <p class="dz-title">Drag & drop an image here</p>
      <p class="dz-sub">or click to browse</p>
    </div>
    <!-- Live preview shows the chosen image before uploading -->
    <img id="preview" class="preview" alt="Image preview" hidden>
  </div>

  <!-- Controls row: optional toggle + submit button -->
  <div class="controls">
    <!-- Nice toggle UI for whether to request detection boxes be drawn -->
    <label class="switch">
      <input type="checkbox" name="show_boxes" checked>
      <!-- The slider is purely visual; CSS turns this into a pill toggle -->
      <span class="slider"></span>
      <span class="switch-label">Show detection boxes (if available)</span>
    </label>

    <!-- Primary action: triggers the upload -->
    <button type="submit" class="btn primary">Analyze Item</button>
  </div>

  <!-- Progress bar: we animate this with a small JS snippet for feedback -->
  <div id="progress" class="progress" hidden>
    <div class="bar" style="width: 0%"></div>
    <span class="progress-text">Uploading…</span>
  </div>

  <!-- If backend sets an error (e.g., missing file), we display it here -->
  {% if error %}
  <p class="error" role="alert">{{ error }}</p>
  {% endif %}
</form>
{% endblock %}

{% block scripts %}
<script>
  // Grab references to key elements we’ll interact with
  const dz = document.getElementById('dropzone');    // the visual drop area
  const input = document.getElementById('fileInput'); // hidden file input
  const preview = document.getElementById('preview'); // preview <img>
  const form = document.getElementById('uploadForm'); // the form
  const progress = document.getElementById('progress');// progress container
  const bar = progress?.querySelector('.bar');        // bar inside progress

  // Helper: set the preview image when a file is chosen
  function setPreview(file) {
    // createObjectURL makes a temporary local URL for the file so we can display it immediately
    const url = URL.createObjectURL(file);
    preview.src = url;
    preview.hidden = false; // reveal the preview <img>
  }

  // Clicking the dropzone should open the system file picker
  dz.addEventListener('click', () => input.click());

  // Keyboard support (accessibility): Enter/Space should also open file picker
  dz.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') input.click();
  });

  // When a file is selected via the file dialog, preview it
  input.addEventListener('change', (e) => {
    const file = e.target.files?.[0];
    if (file && file.type.startsWith('image/')) setPreview(file);
  });

  // When a file is dragged over the dropzone, prevent default so drop works and tweak styles
  dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('drag'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('drag'));

  // Handle dropping a file into the dropzone
  dz.addEventListener('drop', (e) => {
    e.preventDefault();
    dz.classList.remove('drag');
    const file = e.dataTransfer.files?.[0];
    if (file && file.type.startsWith('image/')) {
      // Put the dropped file into the hidden input so the <form> will include it on submit
      const dt = new DataTransfer();
      dt.items.add(file);
      input.files = dt.files;
      setPreview(file);
    }
  });

  // On submit, show a fake progress bar to reassure the user while the request is in flight
  form.addEventListener('submit', () => {
    progress.hidden = false;
    let w = 10;
    const id = setInterval(() => {
      w = Math.min(w + Math.random() * 15, 90); // creep toward 90% until the page navigates
      bar.style.width = w + '%';
      if (w >= 90) clearInterval(id);
    }, 200);
  });
</script>
{% endblock %}
